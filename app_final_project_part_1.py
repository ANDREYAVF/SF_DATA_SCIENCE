#### –§–∏–Ω–∞–ª—å–Ω—ã–π –ø—Ä–æ–µ–∫—Ç. –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è. –ò—Ç–æ–≥–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç. –ß–∞—Å—Ç—å 1. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Streamlit #####
#####################################################################################################
# –ò—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
# –í–∞–º –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω –¥–∞—Ç–∞—Å–µ—Ç, —Å–æ–¥–µ—Ä–∂–∞—â–∏–π —Å–ª–µ–¥—É—é—â–∏–µ —Å—Ç–æ–ª–±—Ü—ã:

# avg_temp ‚Äî —Å—Ä–µ–¥–Ω—è—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞;
# total_precip ‚Äî –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Å–∞–¥–∫–æ–≤;
# avg_wind ‚Äî —Å—Ä–µ–¥–Ω—è—è —Å–∫–æ—Ä–æ—Å—Ç—å –≤–µ—Ç—Ä–∞;
# is_rainy ‚Äî –±–∏–Ω–∞—Ä–Ω—ã–π/–ª–æ–≥–∏—á–µ—Å–∫–∏–π –ø—Ä–∏–∑–Ω–∞–∫ –¥–æ–∂–¥—è.
# –ó–∞–¥–∞—á–∏
# –í—ã –º–æ–∂–µ—Ç–µ –≤—ã–±—Ä–∞—Ç—å –¥–ª—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–ª–µ–¥—É—é—â–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ –≤ –≤–∞—à–µ–º Streamlit-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏:

# –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è –¥–ª—è –≤—ã–±–æ—Ä–∞ –¥–∏–∞–ø–∞–∑–æ–Ω–∞ –¥–∞—Ç.
# –í—ã–≤–æ–¥ –∏—Å—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö:
# –û—Ç–æ–±—Ä–∞–∑–∏—Ç–µ —Ç–∞–±–ª–∏—Ü—É —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–æ –≥–æ—Ä–æ–¥—É –∏–ª–∏ –¥–∏–∞–ø–∞–∑–æ–Ω—É –¥–∞—Ç, –µ—Å–ª–∏ –¥–∞—Ç–∞ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç).
# –î–æ–±–∞–≤—å—Ç–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –∏ –ø–æ—Å—Ç—Ä–∞–Ω–∏—á–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞, –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –º–Ω–æ–≥–æ.
# –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–Ω—ã—Ö (–Ω–æ–≤—ã—Ö) —Å—Ç–æ–ª–±—Ü–æ–≤. –ù–∞ –æ—Å–Ω–æ–≤–µ –∏–º–µ—é—â–∏—Ö—Å—è –¥–∞–Ω–Ω—ã—Ö –¥–æ–±–∞–≤—å—Ç–µ –ø–æ–ª–µ–∑–Ω—ã–µ –≤—ã—á–∏—Å–ª—è–µ–º—ã–µ –ø–æ–ª—è, –Ω–∞–ø—Ä–∏–º–µ—Ä:
# –ö–∞—Ç–µ–≥–æ—Ä–∏—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã ("—Ö–æ–ª–æ–¥–Ω–æ", "—É–º–µ—Ä–µ–Ω–Ω–æ", "–∂–∞—Ä–∫–æ").
# –£—Ä–æ–≤–µ–Ω—å –æ—Å–∞–¥–∫–æ–≤ ("–±–µ–∑ –æ—Å–∞–¥–∫–æ–≤", "–Ω–µ–±–æ–ª—å—à–∏–µ", "—Å–∏–ª—å–Ω—ã–µ").
# –ö–æ–º—Ñ–æ—Ä—Ç–Ω–æ—Å—Ç—å –ø–æ–≥–æ–¥—ã (–ø–æ –≤–∞—à–µ–π –ª–æ–≥–∏–∫–µ, –Ω–∞–ø—Ä–∏–º–µ—Ä, –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã –∏ –≤–µ—Ç—Ä–∞).
# –†–∞–∑–≤–µ–¥–æ—á–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö (EDA):
# –ü–æ—Å—Ç—Ä–æ–π—Ç–µ –≥—Ä–∞—Ñ–∏–∫–∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ (temperature, precipitation, wind_speed): –≥–∏—Å—Ç–æ–≥—Ä–∞–º–º—ã, boxplots.
# –°—Ä–∞–≤–Ω–∏—Ç–µ –ø–æ–≥–æ–¥–Ω—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –º–µ–∂–¥—É —Ä–∞–∑–Ω—ã–º–∏ –≥–æ—Ä–æ–¥–∞–º–∏ (—Å—Ç–æ–ª–±—á–∞—Ç—ã–µ –¥–∏–∞–≥—Ä–∞–º–º—ã, –ª–∏–Ω–µ–π–Ω—ã–µ –≥—Ä–∞—Ñ–∏–∫–∏ –∏ —Ç. –¥.).
# –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ä—è–¥—ã –∏ –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏–µ (–ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç—Å—è, —á—Ç–æ –≤ –¥–∞–Ω–Ω—ã—Ö –µ—Å—Ç—å –≤—Ä–µ–º–µ–Ω–Ω–∞—è –º–µ—Ç–∫–∞ ‚Äî –Ω–∞–ø—Ä–∏–º–µ—Ä, –∫–æ–ª–æ–Ω–∫–∞ date):
# –û—Ç–æ–±—Ä–∞–∑–∏—Ç–µ –¥–∏–Ω–∞–º–∏–∫—É —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã (–∏–ª–∏ –¥—Ä—É–≥–æ–≥–æ –ø–æ–∫–∞–∑–∞—Ç–µ–ª—è) –≤–æ –≤—Ä–µ–º–µ–Ω–∏.
# –†–µ–∞–ª–∏–∑—É–π—Ç–µ –ø—Ä–æ—Å—Ç–æ–π –ø—Ä–æ–≥–Ω–æ–∑ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–∫–æ–ª—å–∑—è—â–µ–≥–æ —Å—Ä–µ–¥–Ω–µ–≥–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –æ–∫–Ω–æ –≤ —Å–µ–º—å –¥–Ω–µ–π) –∏ 
# –æ—Ç–æ–±—Ä–∞–∑–∏—Ç–µ –µ–≥–æ –Ω–∞ –≥—Ä–∞—Ñ–∏–∫–µ –≤–º–µ—Å—Ç–µ —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏.
# –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å:
# –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤–∏–¥–∂–µ—Ç—ã Streamlit (st.selectbox, st.multiselect, st.slider –∏ –¥—Ä—É–≥–∏–µ),
# —á—Ç–æ–±—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–≥ –≤—ã–±–∏—Ä–∞—Ç—å: –≥–æ—Ä–æ–¥(–∞) –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞; –ø–µ—Ä–∏–æ–¥ –≤—Ä–µ–º–µ–Ω–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å –¥–∞—Ç–∞);
# —Ç–∏–ø –≥—Ä–∞—Ñ–∏–∫–∞ –∏–ª–∏ –º–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è.

#####################################################################################################
import streamlit as st
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import seaborn as sns
import sqlite3 # –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –≤—Å—Ç—Ä–æ–µ–Ω–Ω—É—é –±–∏–±–ª–∏–æ—Ç–µ–∫—É Python –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –±–∞–∑–∞–º–∏ –¥–∞–Ω–Ω—ã—Ö SQLite
import polars as pl # –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –±–∏–±–ª–∏–æ—Ç–µ–∫—É Polars
from datetime import date # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º date –∏–∑ datetime

DB_PATH = "C:\Work\IDE\python_DS_example\CURRENCY_BOT\weather.db"

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
st.set_page_config(page_title="WeatherInsight", layout="wide")
st.title("üå¶Ô∏è WeatherInsight: –ü–æ–≥–æ–¥–Ω—ã–µ —Ç—Ä–µ–Ω–¥—ã")

# –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
@st.cache_data # –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä Streamlit, –∫–æ—Ç–æ—Ä—ã–π –∫–µ—à–∏—Ä—É–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Ñ—É–Ω–∫—Ü–∏–∏
def load_data():
    conn = sqlite3.connect(DB_PATH)
    df_pl = pl.read_database("SELECT * FROM weather ORDER BY date", conn)
    # –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –≤ Pandas DataFrame
    df = df_pl.to_pandas()
    conn.close()
    return df

try:
    df = load_data()
except Exception as e:
    st.error("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –¥–æ—Å—Ç—É–ø–Ω–∞.")
    st.stop()


# 2. –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å: —Ñ–∏–ª—å—Ç—Ä—ã
st.sidebar.header("–§–∏–ª—å—Ç—Ä—ã")
selected_cities = st.sidebar.multiselect(
    "–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥–∞",
    options=df['city'].unique(),
    default=df['city'].unique()
)

if df['date'].dtype != 'datetime64[ns]':
    df['date'] = pd.to_datetime(df['date']) # —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–æ–ª–±—Ü–∞ date

date_range = st.sidebar.date_input(
    "–í—ã–±–µ—Ä–∏—Ç–µ –¥–∏–∞–ø–∞–∑–æ–Ω –¥–∞—Ç",
    value=(df['date'].min(), df['date'].max()),
    key="date_range"
)

# 3. –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
if selected_cities:
    df = df[df['city'].isin(selected_cities)]
if date_range and len(date_range) == 2:
    start_date, end_date = date_range
    # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º datetime.date ‚Üí pd.Timestamp
    if isinstance(start_date, date):
        start_date = pd.Timestamp(start_date)
    if isinstance(end_date, date):
        end_date = pd.Timestamp(end_date)

    df = df[(df['date'] >= start_date) & (df['date'] <= end_date)]

# 4. –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–Ω—ã—Ö —Å—Ç–æ–ª–±—Ü–æ–≤
@st.cache_data
def add_derived_columns(df):
    # –ö–∞—Ç–µ–≥–æ—Ä–∏—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã
    conditions = [
        (df['avg_temp'] < 0),
        (df['avg_temp'] >= 0) & (df['avg_temp'] < 15),
        (df['avg_temp'] >= 15) & (df['avg_temp'] < 25),
        (df['avg_temp'] >= 25)
    ]
    choices = ['—Ö–æ–ª–æ–¥–Ω–æ', '—É–º–µ—Ä–µ–Ω–Ω–æ', '—Ç–µ–ø–ª–æ', '–∂–∞—Ä–∫–æ']
    df['temp_category'] = np.select(conditions, choices)


    # –£—Ä–æ–≤–µ–Ω—å –æ—Å–∞–¥–∫–æ–≤
    conditions = [
        (df['total_precip'] == 0),
        (df['total_precip'] > 0) & (df['total_precip'] <= 5),
        (df['total_precip'] > 5)
    ]
    choices = ['–±–µ–∑ –æ—Å–∞–¥–∫–æ–≤', '–Ω–µ–±–æ–ª—å—à–∏–µ', '—Å–∏–ª—å–Ω—ã–µ']
    df['precip_level'] = np.select(conditions, choices)

    # –ö–æ–º—Ñ–æ—Ä—Ç–Ω–æ—Å—Ç—å –ø–æ–≥–æ–¥—ã (—É–ø—Ä–æ—â—ë–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞)
    df['comfort'] = np.where(
        (df['avg_temp'].between(15, 25)) &
        (df['avg_wind'] < 10) &
        (df['precip_level'] != '—Å–∏–ª—å–Ω—ã–µ'),
        '–∫–æ–º—Ñ–æ—Ä—Ç–Ω–æ',
        '–Ω–µ–∫–æ–º—Ñ–æ—Ä—Ç–Ω–æ'
    )
    return df

df = add_derived_columns(df)

# 5. –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏—Å—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
st.header("–ò—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ")
st.dataframe(df.style.highlight_max(axis=0), height=400)

# 6. –†–∞–∑–≤–µ–¥–æ—á–Ω—ã–π –∞–Ω–∞–ª–∏–∑ (EDA)
st.header("–†–∞–∑–≤–µ–¥–æ—á–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö (EDA)")

col1, col2, col3 = st.columns(3)

with col1:
    st.subheader("–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã")
    fig, ax = plt.subplots(figsize=(5, 4))
    sns.histplot(df['avg_temp'], kde=True, ax=ax)
    ax.set_title("–ì–∏—Å—Ç–æ–≥—Ä–∞–º–º–∞ avg_temp")
    st.pyplot(fig)

with col2:
    st.subheader("Boxplot –æ—Å–∞–¥–∫–æ–≤")
    fig, ax = plt.subplots(figsize=(5, 4))
    sns.boxplot(y=df['total_precip'], ax=ax)
    ax.set_title("Boxplot total_precip")
    st.pyplot(fig)

with col3:
    st.subheader("–°–∫–æ—Ä–æ—Å—Ç—å –≤–µ—Ç—Ä–∞")
    fig, ax = plt.subplots(figsize=(5, 4))
    sns.kdeplot(df['avg_wind'], ax=ax)
    ax.set_title("–ü–ª–æ—Ç–Ω–æ—Å—Ç—å avg_wind")
    st.pyplot(fig)

# 7. –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –≥–æ—Ä–æ–¥–æ–≤
st.subheader("–°—Ä–∞–≤–Ω–µ–Ω–∏–µ –≥–æ—Ä–æ–¥–æ–≤")
city_group = df.groupby('city')[['avg_temp', 'total_precip', 'avg_wind']].mean()

fig, ax = plt.subplots(figsize=(10, 5))
city_group.plot(kind='bar', ax=ax)
ax.set_title("–°—Ä–µ–¥–Ω–∏–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –ø–æ –≥–æ—Ä–æ–¥–∞–º")
ax.legend(title="–ü–æ–∫–∞–∑–∞—Ç–µ–ª–∏")
st.pyplot(fig)

# 8. –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ä—è–¥—ã –∏ –ø—Ä–æ–≥–Ω–æ–∑
st.header("–î–∏–Ω–∞–º–∏–∫–∞ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã")


# –°–∫–æ–ª—å–∑—è—â–µ–µ —Å—Ä–µ–¥–Ω–µ–µ (–æ–∫–Ω–æ 7 –¥–Ω–µ–π)
df_sorted = df.sort_values('date')
df_sorted['temp_ma7'] = df_sorted['avg_temp'].rolling(window=7).mean()


fig, ax = plt.subplots(figsize=(12, 6))
ax.plot(df_sorted['date'], df_sorted['avg_temp'], label='–†–µ–∞–ª—å–Ω–∞—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞', alpha=0.7)
ax.plot(df_sorted['date'], df_sorted['temp_ma7'], label='–°–∫–æ–ª—å–∑—è—â–µ–µ —Å—Ä–µ–¥–Ω–µ–µ (7 –¥–Ω)', linewidth=2)
ax.set_xlabel("–î–∞—Ç–∞")
ax.set_ylabel("–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ (¬∞C)")
ax.legend()
ax.grid(True)
st.pyplot(fig)

# 9. –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å: –≤—ã–±–æ—Ä –≥—Ä–∞—Ñ–∏–∫–∞
st.sidebar.header("–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è")
chart_type = st.sidebar.selectbox(
    "–¢–∏–ø –≥—Ä–∞—Ñ–∏–∫–∞",
    ["–ì–∏—Å—Ç–æ–≥—Ä–∞–º–º–∞", "Boxplot", "–õ–∏–Ω–µ–π–Ω—ã–π –≥—Ä–∞—Ñ–∏–∫"]
)

if chart_type == "–ì–∏—Å—Ç–æ–≥—Ä–∞–º–º–∞":
    st.subheader("–ì–∏—Å—Ç–æ–≥—Ä–∞–º–º–∞ –æ—Å–∞–¥–∫–æ–≤")
    fig, ax = plt.subplots()
    ax.hist(df['total_precip'], bins=20)
    st.pyplot(fig)
elif chart_type == "Boxplot":
    st.subheader("Boxplot —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã")
    fig, ax = plt.subplots()
    sns.boxplot(data=df, y='avg_temp', ax=ax)
    st.pyplot(fig)
else:
    st.subheader("–õ–∏–Ω–µ–π–Ω—ã–π –≥—Ä–∞—Ñ–∏–∫ –≤–µ—Ç—Ä–∞")
    fig, ax = plt.subplots()
    ax.plot(df['date'], df['avg_wind'])
    st.pyplot(fig)


# 10. –ò—Ç–æ–≥
st.sidebar.success("–ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à—ë–Ω!")